= Message exchange for flow management in maritime traffic management systems.
Thomas Borg Salling <tbsalling@tbsalling.dk>
v0.1, January 20, 2015: 1st draft for review.
:keywords: imo, iala, ais, itu-r-1371, monalisa, ten-t
:toc-placement: preamble
:icons: font

Prepared by the http://dma.dk[Danish Maritime Authority] as part of the http://monalisaproject.eu/[MONA LISA 2] project.

image::images/dma.png[align="center", scaledwidth="25%"]
image::images/monalisa2.png[align="center"]
image::images/eu.png[align="center"]

[cols="1,2,4,4"]
|===
|v0.1 |20 JAN 2015 |Thomas Borg Salling <tbsalling@tbsalling.dk> |1st draft for review.
|v0.2 |xx JAN 2015 |Thomas Borg Salling <tbsalling@tbsalling.dk> |
|===

[abstract]
== Abstract
...

:numbered:

== Introduction
As part of -- and as a contribution to -- the MONA LISA 2.0 <<MONALISA2>> project, the Danish Maritime Authority has worked to define message conversation scenarios and detailed message formats for _flow management_ in the context of _sea traffic management (STM)_ as defined by <<ARCH>>.

The results contain inputs, contributions, and insights from DMA and project partners.

This paper documents the process and the the results, by

. defining the domain problem,
. setting the scope of work,
. establishing design criteria,
. proposing message conversation scenarios,
. defining message formats in different formats,
. validating message formats against design criteria,
. introducing a reference implementation for AIS using application specific messages, and by
. supplying test data to validate correctness.

The official point of contact for questions and comments is:

.Point of contact
****
Danish Maritime Authority +
_Dept. of Technology and Business Development_

M.Sc. Jens Kristian Jensen <JKJ@dma.dk>
****

=== Problem definition

==== Flow management
As defined by <<ARCH>> flow management is communication which takes place between ships in a peer-to-peer situation, or between ships and a coordinating organisation (denoted STCC in this document, similar to a VTS conducting some level of service similar to Traffic Organisation Service) in order to:

1. Increase safety and prevent delays through a good flow in narrow channels with high traffic density.
1. Support vessel in arriving at final destination in due time as efficient as possible.
1. Provide information to interested parties about planned and predicted time of arrival to final destination or other point of interest.

For item 1 the term "good" means that collisions and dangerous situations are avoided and that vessels can safely follow their announced tactical voyageplan through the area.

Flow _management_ is based on knowledge of vessels' tactical voyageplans; i.e. announcements from each vessel regarding their intended manouvers in the immediate short-term future. When this knowledge is known either centrally at a coordinating center or distributed between nearby vessels, it is possible for a vessel to better understand the intentions of other nearby vessels and adjust own tactical route to achieve better flow, or for the coordination centre to suggest adjustments to tactical route, with the purpose of obtaining a "good" overall flow. This process is called _flow management_.

If flow management takes place in a self-organizing manner between vessels on a peer-to-peer basis it is called _autonomous flow management_. When a coordinating center is performing it the process is called _controlled flow management_. In a fully managed scenario -- whether autonomous or controlled -- the risk of situations escalating to a level that require the application of collision avoidance regulations can be minimized.

===== Tactical voyageplan
In order to facilitate flow management vessels in the area must broadcast their tactical voyageplan and optionally basic information concerning their manouvering capabilities, such as turning radius.

===== Flow management suggestion
A suggested change to a tactical voyageplan is called a _flow management suggestion_. It can take one of two principal forms:

1. Geometry-based (adding, deleting or changing waypoints)
1. Speed-based (not changing any waypoints)

Changing the geometry of an tactical voyageplan is a relatively complex operation for the vessel's navigator. Among other things the process involves a safety check of the new route and reprogramming of navigational equipment. The cost/workload of this operation reduces the likelihood of a vessel complying with suggested changes.

Changing the vessel's speed (or waypoint ETA's) is a far simpler operation for the navigator. This involves only adjustment of the vessel's speed. It is therefore expected, that the likelihood of a of vessel complying with a suggested change of this type is higher than suggested changes to geometry.

==== Controlled flow management
Controlled flow management always takes place inside a defined geographical area called the _controlled area_. The controlled area is a closed polygon.

Vessels can be located inside the controlled area -- or outside the controlled area.

Vessels outside the controlled area can be in state

- _entering_ -- meaning that the vessel intends to enter the controlled area.

Vessels inside the controlled area can be in states

- _leaving_ -- meaning that the vessel intends to leave the controlled area.
- _staying_ -- meaning that the vessel intends to seek berth, drop anchor, or elsehow keep manouvering inside the area.

Some of the vessels are aware of some of the other vessels' tactical voyageplans, and the coordination centre is aware of some of the vessel's tactical voyageplans.

As any coordinating organization the coordination centre is continuously receiving an AIS data stream, including type 1-3 position messages and type 5 ship and static voyage messages, so that it can maintain an updated real-time picture of the current traffic situation.

[[img-controlled-area]]
.A controlled area and five vessels showing their intended routes. There are vessels outside (1, 2) and vessels inside (3-5) the controleld area. A vessel (2) is entering, a vessel is leaving (3), and two vessels are staying (4 ,5).
image::images/controlled_area.png[img-controlled-area, align="center"]

==== Autonomous flow management
It has previously been observed in simulator trials, that given the information about the more detailed intentions of other vessels, and the ability to express own tactical plan to peer vessels, navigators quickly adapt to utilizing this mechanism, to clearly express own intention in a narrow passage situation.

Autonomous flow management is thus anticipated to evolve out of the availability of information, that enable navigation systems to better predict realistic CPA and TCPA values and pinpoint likely critical passages at larger distances and longer timewindows, based on sharing the information on the tactical routes of peer vessels.

=== Scope of work
The scope of the work in this paper is _controlled flow management in a limited area (in order of size as a VTS area) based on flow management suggestions in the speed-based form_.

Use cases will be used to describe the events and actions of conversations (information exchange) that could support a flow management scenario.

Design criteria and specific design proposals will be described for messages  and conversation sequences, first in generic terms, independant of data transport mechanism, later in specific terms related to utilizing AIS as the communication channel and the Maritime Messaging Service in the Maritime Cloud taking into account the specific limitations of the transport channel.

[[use_cases]]
== Use cases

=== Use case: Vessel enters the controlled area

{set:step:0}
[cols="1,5,5"]
.Use case.
|===
| No. | Event | Action

| {counter:step} | The coordination centre detects, that a vessel has entered the controlled area. | The control centre transmits an addressed message to the vessel requesting it broadcast tactical voyageplans.footnote:[This is done even if the coordination centre already has this information in order to distribute this information to other vessels in the area.]
| {counter:step} | The vessel receives the message. | The vessel responds by broadcasting a message containing its tactical voyageplan.
.2+| {counter:step} | The broadcast is received by the coordination centre (and likely some of the other vessels in the area). | The control centre recalculates optimal speeds per vessel.footnote:[with priority to suggest speed changes for V~0~ over other vessels, and fewest possible other vessels, and only for vessels intending to leave A.]
| *Exception:* The broadcast is never received by the coordination centre. | The coordination centre retransmits its message to the vessel.
| {counter:step} | The coordination centre's recalculation of optimal speeds completes. | The coordination centre transmits an addressed messages with flow management suggestion s to those vessels which (according to the calculation) require changes.
.2+| {counter:step} | A vessel receives its flow management suggestion from the coordination centre. | The navigator is alerted.
| *Exception:* The flow management suggestion is never received by the vessel. | _May lead to special case: Coordination centre discovers new suggestions needed._
| {counter:step} | Navigator of approves flow management suggestion . | The vessel broadcasts a message containing its new tactical voyageplan.
|===

[[use_case_cc_emits_fmm]]
=== Use case: Coordination centre determines new flow management suggestion s needed

{set:step:0}
[cols="1,5,5"]
.Use case.
|===
| No. | Event | Action

| {counter:step} | The coordination centre detects that the current flow is not optimal ("good") | The control centre recalculates optimal speeds per vessel.
| {counter:step} | The coordination centre's recalculation of optimal speeds completes. | The coordination centre transmits an addressed messages with flow management suggestion s to those vessels which (according to the calculation) require changes.
.2+| {counter:step} | A vessel receives its flow management suggestion  from the coordination centre. | The navigator is alerted.
| *Exception:* The flow management suggestion is never received (or is ignored) by the vessel. | _May lead to special case: Coordination centre discovers new suggestions needed._
| {counter:step} | Navigator of approves flow management suggestion . | The vessel broadcasts a message containing its new tactical voyageplan.
|===

[[use_case_vessel_emits_tvp]]
=== Use case: Vessel autonomously broadcasts its tactical voyageplan

{set:step:0}
[cols="1,5,5"]
.Use case.
|===
| No. | Event | Action

| {counter:step} | Due to some event (examples: A recurring period expiring, a change to the current tactical voyageplan or expiration of a previously broadcasted tactical voyageplan) a vessel decides to broadcast its tactical voyageplan. | The vessel broadcasts a message containing its tactical voyageplan.
.2+| {counter:step} | Other vessels receive the message. | The receiving vessel(s) may decide to change their intended manouvers based on knowledge of the transmitting vessels tactical voyageplan.
|A coordination center receives the message.
| The coordination center engages into <<use_case_cc_emits_fmm>>.
|===

=== Use case: Vessel cancels its tactical voyageplan

{set:step:0}
[cols="1,5,5"]
.Use case.
|===
| No. | Event | Action

| {counter:step} | The navigator of a vessel decides to cancel a previously broadcasted tactical voyageplan. | The vessel broadcasts a message containing cancellation of tactical voyageplan.
.2+| {counter:step} | Other vessels receive the message. | The receiving vessel(s) may decide to change their intended manouvers based on knowledge of the transmitting vessels tactical voyageplan. They may engage into <<use_case_vessel_emits_tvp>>.
|A coordination center receives the message.
| The coordination center engages into <<use_case_cc_emits_fmm>>.
|===

=== Use case: A vessel inquiries about the tactical voyageplan of another vessel

{set:step:0}
[cols="1,5,5"]
.Use case.
|===
| No. | Event | Action

| {counter:step} | The navigator of a vessel, V~_L_~, determines, that either
a) has he never received the tactical voyageplan of another vessel footnote:[This could happen in case of e.g. radio conditions in an area being so that _some_ (but not all) vessels fail to receive broadcasts from some other vessels.], V~_R_~, or b) the observed manouvers of V~_R_~ deviate from the last received tactical voaygeplan from V~_R_~ | The navigator of V~_L_~ orders transmission of a voyageplan inquiry addressed to V~_R_~.
| {counter:step} | V~_R_~ receives the message. | Automatically - or based on navigator actions - V~_R_~ broadcasts a message carrying its tactical voyageplan.
.2+| {counter:step} | Other vessels, including V~_L_~, receive the message. | The receiving vessel(s) may decide to change their intended manouvers based on knowledge of the transmitting vessels tactical voyageplan. They may engage into <<use_case_vessel_emits_tvp>>.
|A coordination center receives the message.
| The coordination center engages into <<use_case_cc_emits_fmm>>.
|===

== Design criteria
Messaging in the maritime domain has been available many years and communication standards have evolved and been added and augmented several times to accomodate the increasing demand for handling more and more complex scenarios in the maritime domain.

When suggesting message exchange for advanced use cases, such as for flow management, we want to take lessons learned from the past years into account. Literature, such as <<TOILS>>, has therefore been studied to establish a set of design criteria for the messages that are defined for flow management.

In section <<design_validation>> it will be validated, that the suggested messages layouts and payloads are in compliance with these design criteria.

=== General design criteria

==== Design with the end-user in mind
In accordance with <<ARCH>>, §3, all systems shall be designed with the end user (e.g. mariner, ship owner, operator), in mind.

====
This shall be achieved, by carefully identifying and defining use cases expressed in user domain terms and approved by user domain experts (such as navigators) before the actual design of message conversations and message layouts takes place. And by validating that the detailed message designs support the defined use cases.
====

==== Design for multivendor environment
In accordance with <<ARCH>>, §3 p.6, one of the main goals (here interpreted as _design criteria_) of the MONALISA 2.0 project is to "achieve full and seamless interoperability of systems in Sea Traffic Management (STM) [...] in a multi-vendor environment".

====
This shall be achieved by ensuring that relevant stakeholders in government and industry can contribute to and review the design of conversations and messages in flow management.
====

==== Information transfer involving ships must be bandwidth efficient
In accordance with <<ARCH>>, §7 p.23, information transfer involving ships must be highly bandwidth efficient.

====
This shall be achieved by designing messages to be as compact as possible, avoiding redundant information in message layouts, and using bit-level compression where applicable and possible.
====

==== Interactions must be robust
In accordance with <<ARCH>>, §7 p.23, ship-shore interactions must be robust to unstable, changing, high latency links.

====
This shall be achieved by designing conversation for robustness - supplement a repetitive broadcast regime with a request/response mechanism, which is activated when a user (ship or shorebased) actively investigates a particular ships intentions, in case the latest revieved broadcast is not sufficiently recent.

If the data transport mechanism supports transport layer acknowledgements, the request/response mechanism can be safeguarded against a message transmission being lost through utilizing these acknowledgement mechanisms.
====

==== Ship-shore data IP connections must be initiated from ship
In accordance with <<ARCH>>, §7 p.23, ship-shore data connections must be initiated from ship, to address cyber security.

====
This shall be achieved by designing the required mechanisms of communication, such that ship-to-shore communication is based on IP-based connection-oriented communication (e.g. TCP/IP), then such a connection can only be initiated from the ship-side.
====

==== Indication of trust
When utilizing AIS, anyone can spoof the identity of a ship and interact with others. If utilizing the Maritime Messaging Service -- or some other transport mechanism that offer mechanisms for secure data transport -- the authenticity and integrity of the information exchanged could possibly be guaranteed.

It is important to a navigator or STCC to be able to determine the security level of the information provided.

====
This shall be achived by designin the user interface of the receiving party to indicate the level of trust that can be associated with the sender.
====

=== AIS-specific design criteria

==== Consider updated definitions of ASM and related guidance, before developing new ASM;
In accordance with <<IALA144>>, recommendation 4, IALA recommends that members make use of the IALA ASM collection <<AISASM>> by taking into account other updated definitions of ASM and related guidance, before developing new or implementing the use of existing Regional ASM.

====
This shall be achieved by consulting the ASM collection <<AISASM>> to ensure that no other existing ASM already fulfills the requirements of any newly designed message before it is submitted for approval.
====

==== Contribute to the IALA AIS ASM collection
In accordance with <<IALA144>>, recommendation 6, members are recommended to contribute to the IALA ASM collection through their National IALA Member.

====
This shall be achieved by ensuring that the final and agreed ASM messages to support flow management are submitted to the IALA ASM collection by the national IALA member, in this case the Danish Maritime Authority.
====

==== Low transmission frequency
In accordance with <<IMOSN289>>, §3.3, the frequency of message transmission should be limited in order to prevent system overload.

====
This shall be achieved by careful design of the criteria which trigger a message transmission, in order to minimise the number of transmissions to the lowest possible.
====

==== Limit no. of VHF transmission slots
In accordance with <<IMOSN289>>, §3.4, AIS messages occupying more than three (3) slots should be avoided, unless there is a low load on the VDL or a compelling reason to do so.

====
This shall be achieved by designing messages to avoid occupying more than 3 slots.
====

==== Use 6-bit ASCII
As pointed out by <<TOILS>> the decision to use 6-bit ASCII encoding in AIS messages is a _blunder_. But as it states: "Some major defects, such as the handling of string data, are too deeply embedded to be removed". Thus in the design of new messages, the 6-bit encoding scheme will be maintained to avoid further complexity to <<AISSPEC5>> and related recommendations and guidelines.

This case is an example of a design blunder, where one possible remedy -- which could promote good quality software -- would be the existence of open source reference implementations of 6-bit ASCII encoding/decoding functions in different programming languages, as a shared, well tested resource.

====
This shall be achieved by designing string fields of new messages to use the 6-bit character encoding scheme defined by <<AISSPEC5>> annex 8.
====

==== Fixed length messages
By experience and in accordance with <<TOILS>>, "types 1 through 4: Fixed-length felicity", fixed-length messages are simple to parse and can be regarded as one production in the message _grammar_. <<TOILS>> further states, that "from a reliability-engineering point of view, this [fixed-length messages] is a best case scenario".

====
This shall be achived by designing any new messages, so that they have fixed bit-length and fixed field-offsets, unless there are important and documented reasons why this cannot be achieved.
====

==== Fixed bit-offset for fields
<<TOILS>>, "Ways forward for AIS", recommends to avoid fields with variable offsets.

====
This shall be achieved by designing new ASMs to have fixed bit-length for each data field to ensure that each data fields starts at a fixed bit-offset.
====

==== Variable fields last
According to <<TOILS>>, "Drawing lessons from the defects", it is a minor defect not to have variable-length fields be the last in the message (such as the variable-length binary payload in message type 26 followed by a radio-status field). Variable-length fieds should first and foremost be avoided. And if, for compelling reasons, they cannot - they should be transmitted last in the message to preserve fixed-offset for as many data fields as possible.

====
This shall be achieved by designing new ASMs so that any variable-length data fields are at the end of the message.
====

==== One dispatch field
<<TOILS>> states in several places that the no. of protocol extension mechanisms should be minimal and preferably limited to 1. Any _dispatch fields_ used to control message variants (such as the message type field), should precede any of the data fields it controls.

====
This shall be achieved by designing new ASMs so that no new extension mechanisms are introdued, to use a minimal no. of dispatch fields, and take dispatch fields into use in the following order: Message ID, Application Identifier, Message-specific dispatch.
====

[[minimum_datatypes]]
==== Minimum no. of datatypes
<<TOILS>> states that good practice is "for there to be just one type per natural kind; e.g. in a geolocation protocol all longitudes should be encoded with the same length, signedness, and special values. Ditto all latitudes, bearings, timestamp fields, etc.". This also holds for the encoding of numeric valuesfootnote:[Such as e.g. the "Rate of Turn field in the Common Navigation Block required taking a (sign-preserving) square root and then scaling" - which is different from all other numeric fields.] and the indication of non-existent values in order to avoid complicating exception and variants.

====
This shall be achieved by designing new ASMs so that they do not introduce any unnecessart new data type or encodings, and so that they (re-)use the most common and widely used type encoding used elsewhere in <<AISSPEC5>>.
====

[[single_point_of_truth]]
==== Single point of truth
<<TOILS>> recommends, based on lessons learned from message types 6 and 8, that messages should obey the "single point of truth" principle. This means that there should be no information redundancy inherint in the message, and that one piece of information can only be deduced from a single source in the message.

====
This shall be achieved by designing new ASMs so that no piece of information is redundant with other information in the same message.
====

==== Support stream-based parsers
<<TOILS>> recommends, based on lessons learned from message type 22, that in order to preserve memory and reduce decoder complexity, stream-based decoders must be supported by the message layouts. I.e. decoders which can decode incoming messages without looking ahead in the bit stream.

====
This shall be achieved by designing new ASMs so that any dispatch-field, changing the interpretation of the message, is transmitted _before_ the data fields whose interpretation it influences.
====

==== Don't split data fields across datagrams
As pointed out by <<TOILS>> some AIS messages, such as type 24, need to be reconstructed from two individually transmitted datagrams. This increases decoder complexity by requiring it to hold state between datagrams - and it adds a new dimension to the set of edge cases and problem scenarios, that must be foreseen. Therefore messages split across multiple datagrams must be avoided and all datagrams must be independent.

====
This shall be achieved be designing any new ASMs to that their entire state is communicated in a single datagram.
====

==== Check design using ASN.1
<<TOILS>>, "Drawing lessons from the implementations", recommends "that application-protocol designers should, as a routine part of their process, render the design as a specification in [ASN.1] or [BDEC]."

====
This shall be achieved by supplying ASN.1 notation for each new ASM proposed.
====

==== Provide a reference implementation
<<TOILS>>, "Drawing lessons from the implementations", recommends to "do a reference implementation before you publish an application protocol as a standard" and "as a best practice, the reference implementation should be open source".

====
This shall be achieved by developing an open source reference implementation of a decoder for each proposed ASM. This reference implementation must be able to decode all variants of the ASM and should be developed before the protocol is published as a standard.
====

==== Provide test data sets for all message variants
<<TOILS>>, "Drawing lessons from the implementations", recommends that "an example binary datagram in each of every possible variation of message shape together with a textual, human-readable decode of that datagram" is supplied to enable test and validation of decoders.

====
This shall be achieved by supplying example datagrams together with a human-readable decode of that datagram for each message variant.
====

== Design of flow management message types and conversations

=== High-level design
In the high-level design of flow management messages no assumptions are made about the characteristics of the underlying transport layer. Focus here is to identify which pieces of information need to be exchanged, between whom, and when. Following this are detailed specifications mapping this outcome to specific protocols, such as AIS <<AISSPEC5>>.

The messages to support flow management must have following characteristics:

- The message payload should be related to the current tactical execution, the imminent future. I.e. the message should not be designed for planning purposes or announcement of future intentions.
- The message should have carrying capability for as many waypoints as possible.
- The message should optionally support ETA or SOG per waypoint and vessel's TR.

==== Message types
Based on the <<use_cases>> it is noted, that the following messages are involved in flow management:

- *tactical voyageplan broadcast*. For a vessel to broadcast its tactical voyageplans.
- *tactical voyageplan inquiry*. An addressed message transmitted by coordination centers and vessels to inquire a vessel about its tactical voyageplan.
- *flow management suggestion*. An addressed message transmitted by coordination centers and vessels to suggest changes to a vessel's announced tactical voyageplan.

==== Payloads and transmission triggers

The sugested payloads and transmission triggers of these message types are the following.

===== Tactical voyageplan broadcast

[cols="4,2,8"]
.Information payload of message type *tactical voyageplan broadcast*.
|===
| Data field | Type | Description

| Source ID | Required | Identity of sender, i.e. the vessel which owns the tactical route
| Activation indicator | Required | Indication of whether the vessel cancels/deactives its voyageplan or whether it actively follows it.
| Waypoints | Required | Positions of waypoints on the tactical voyageplan.
| Active waypoint | Required | Indication of which of the waypoints the vessel is currently navigating towards.
| TR | Optional | Ship's turning circle radius in the current area (read more in <<definitions>>).
| ETA active waypoint | Required | Estimated time of arrival at active waypoint.
| ETA last waypoint | Required | Estimated time of arrival at last waypoint.
| ETA other waypoints | Optional | Estimated time of arrival at respective waypoint.
|===

The message must only be transmitted by vessels.

The message is only transmitted if vessel is conned along an active voyageplan. In that case, the following transmission triggers apply:

1. Periodically.footnote:[Using AIS: To use periodic transmission intervals as defined for _dynamic information_ in Table 1 of <<AISSPEC5>> (§4.2.1)]
1. On voyage plan activation.
1. On voyage plan change (change to waypoints or ETA at waypoints).
1. On voyage plan deactivation/cancellation.
1. On change of active waypoint.
1. As reply to message "tactical voyageplan inquiry".

Retransmission is not applicable.

===== Tactical voyageplan inquiry

[cols="4,2,8"]
.Information payload of message type *tactical voyageplan broadcast*.
|===
| Data field | Type | Description

| Destination ID | Required | Receiver identification
| Source ID | Required | Sender identification
| Duration| Required | Relative time for which the vessel is requested to transmit tactical voyageplan periodically.
|===

The message can be transmitted by vessels or shore-based coordination centres.

Retransmission is not applicable.

The following transmission triggers apply:

1. On need by control centre to receive tactical voyageplan from a vessel. In case of e.g.:
- Vessel's arrival to controlled area.
- Previously announced tactical voyageplan is invalid (e.g. expired, or vessel's manouvers deviate significantly from it).
- Loss of data in control center.
1. On need by vessel to receive tactical voyageplan from another vessel.
- The inquired vessel's intentions are unknown to the inquirying vessel; e.g. in case of
* Tactical voyageplan was never transmitted by inquired vessel.
* Tactical voyageplan was never received by inquirying vessel.
* Information about another vessel's tactical voyageplan was lost onboard the inquirying vessel (e.g. due to system restart or improper operation).
- The age of the most recently received tactical route from is higher than the nominal periodic update rate.

===== Flow management suggestion

[cols="4,2,8"]
.Information payload of message type *flow management suggestion*.
|===
| Data field | Type | Description

| Source ID | Required | Sender identification
| Waypoints | Required | Positions of waypoints on the tactical voyageplan.
| Suggested active waypoint | Required | Indication of which of the waypoints the vessel is currently navigating towards.
| Suggested ETA of suggested active waypoint | Required | Suggested time of arrival at active waypoint.
| Suggested ETA of suggested last waypoint | Required | Suggested time of arrival at last waypoint.
| Suggested ETA of other suggested waypoints | Optional | Suggested time of arrival at respective waypoint.
|===

The message must only be transmitted by shore-based coordination centres. It can only be addressed to vessels following an active tactical voyageplan announced via the tactical voyageplan broadcast message.

Retransmission is not applicable.

The following transmission triggers apply:

1. On need to suggest changes to tactical voyageplan to support flow management. E.g. if a coordination center determines, that better overall flow can be achieved by the receiving vessel:
- changing ETA to announced waypoints.

=== Detailed message design

==== ASN.1
*TBD*

==== MSDL
*TBD*

==== AIS

===== Existing ASMs
A search in <<ASMCOLL>> reveals to candidate ASM's worth considering for the "tactical voyageplan" broadcast:

|===
|Title |Msg |DAC |FI |SU |Status |Registrant |Spec

|Route information |8	|1 |27 |5 |in force |IMO Circ. 289 |<<ASM_001_27>>
|Intended route	|8	|219	|1	|3	|initiation	|Danish Maritime Authority |<<ASM_219_01>>
|===

A search in <<ASMCOLL>> reveals to candidate ASM's worth considering for the "flow management suggestion":

|===
|Title |Msg |DAC |FI |SU |Status |Registrant |Spec

|Route suggestion |6|219 |2 |5 |initiation	|Danish Maritime Authority |<<ASM_219_02>>
|===

====== Review of ASM DAC=001; FI=27 - "Route information"

Review of the application specific message DAC=001; FI=27 defined by <<ASM_001_27>> in the context of flow management yields the following comments:

1. <<ASM_001_27>> specifies that "_13.1 This message ... should only be used in when important route information ... – not already provided by current official nautical charts or publications – needs to be relayed by authorities or vessels_". +
+
It is unclear whether a tactical voyageplan (in MONALISA terms) is "important route information". Certainly tactical voyageplans are not normally on any charts or publications; but are they "important" in the context of this message type?
1. <<ASM_001_27>> specifies that "_13.4 In order to allow advance notice, this message should be transmitted prior to the start date and time specified for the routing information. It should not be transmitted more than one day in advance_". +
+
The statement that the message should not "should not be transmitted more than one day in advance" indicates that this message is for planning purposes, and not related to the imminent tactical situation.
1. In the message layout <<ASM_001_27>> there is a field called "sender classification" which can only take one legal value: "1 = authority". Values 2-7 are reserved for future use. The value 0 is not defined in the specification, but since §13.1 indicates that the message can be used by vessels, perhaps 0 means that the sender is a vessel. But this is unclear.
1. The data field "duration" occupies 18 bits and thus supports a max. value of 262142 minutes (using 262143 to indicate value not available) <<ASM_001_27>>. 262142 minutes equals 4.369 hours or 182 days. This is far beyong the needs for a tactical voyageplan and is therefore not efficient bit-usage for this purpose.
1. In <<ASM_001_27>> the data field "number of waypoints" is redundant with message length and thus violates the design criteria <<single_point_of_truth>>. Since the specification states that "The number of waypoints is determined by the length of the message." the presence of this field is a mystery. 5 bits could be saved.
1. The message does not support individual ETA or turn radius per waypoint or SOG between waypoints.

In conclusion, DAC=001; FI=27 has an unclear specification, inefficient bit usage, and appears to be intended for planning purposes rather than the imminent tactical situation.

Therefore DAC=001; FI=27 is not suitable or recommmended for use in flow management.

====== Review of ASM DAC=219; FI=01 - "Intended route"

Review of the application specific message DAC=219; FI=01 defined by <<ASM_219_01>> in the context of flow management yields the following comments:

1. It is well-defined _when_ this message must be sent.
1. First waypoint is always active waypoint - thus the message only carries future intentions.
1. The data field "ETA active WP" can be set one year ahead. The good thing about this, is that it complies with the <<minimum_datatypes>> design criteria; but the bad thing is that it wastes bits; since the lifespan of a tactical voyageplan can probably be expressed in the order of hundres of minutes correponding to 10 bits of information.
1. In <<ASM_219_01>> the data field "number of waypoints" is redundant with message length and thus violates the design criteria <<single_point_of_truth>>. It is unclear whether message length or data field "number of waypoints" determines the no. of waypoint. In either case, the bits used for the data field "number of waypoints" could be saved.
1. The message does not support individual ETA or turn radius per waypoint or SOG between waypoints.

In conclusion, DAC=219; FI=01 has some of the same discrepancies as DAC=001; FI=27, but the events which trigger transmission are more well-defined, it is clear that this message is transmitted by vessels (not shore stations); and it is clear that this message intended for communicating immediate navigation intentions in the same way as required for tactical voyageplans.

Therefore it is recommended
- to use DAC=219; FI=01 as a means for vessels to broadcast their tactical voyageplans flow management.
- to suggest one new message, with the same purpose as DAC=219; FI=01, but with the extended capability of expressing individual ETA and turn radius per waypoint.

====== Review of ASM DAC=219; FI=02 - "Route suggestion"
Review of the application specific message DAC=219; FI=01 defined by <<ASM_219_01>> in the context of flow management yields the following comments:

1. The purpose of this message is to suggest a new route _geometry_.
1. The message does not support individual ETA or turn radius per waypoint or SOG between waypoints.
1. The data field "ETA active WP" can be set one year ahead. The good thing about this, is that it complies with the <<minimum_datatypes>> design criteria; but the bad thing is that it wastes bits; since the lifespan of a tactical voyageplan can probably be expressed in the order of hundres of minutes correponding to 10 bits of information.
1. In <<ASM_219_02>> the data field "number of waypoints" is redundant with message length and thus violates the design criteria <<single_point_of_truth>>. It is unclear whether message length or data field "number of waypoints" determines the no. of waypoint. In either case, the bits used for the data field "number of waypoints" could be saved.

In conclusion, DAC=219; FI=02 has some of the same discrepancies as DAC=001; FI=27. It is clear that this message intended for communicating suggestions of route geometry - not speed-based flow management.

Therefore DAC=219; FI=02 is not suitable or recommmended for use in flow management.

==== Suggested AIS messages to support flow management
Following the arguments above, the following AIS messages are suggested to be used or defined for use in flow management:

|===
|Message purpose |Message type |Defined by

|Tactical voyageplan broadcast           | ASM DAC=219; FI=01 |<<ASM_219_01>> +
Appendix: <<tactical_voyageplan_broadcast>>
|Tactical voyageplan broadcast, extended | ASM DAC=219; FI=02 |Appendix: <<tactical_voyageplan_broadcast_extended>>.
|Tactical voyageplan inquiry             | ASM DAC=001; FI=03 |Appendix: <<tactical_voyageplan_inquiry>>.
|Flow management suggestion              | ASM DAC=219; FI=04 |Appendix: <<flow_management_suggestion>>.
|===

[[design_validation]]
== Validation against design criteria

=== General design criteria
[cols="1,5,5"]
|===
| No. | Criteria | Validation

| 1 | Design with the end-user in mind | -
| 2| Design for multivendor environment | -
| 3| Information transfer involving ships must be bandwidth efficient | -
| 4| Ship-shore interactions must be robust | -
| 5| Ship-shore data IP connections must be initiated from ship | -
|===

=== AIS-specific design criteria
[cols="1,5,5"]
|===
| No. | Criteria | Validation

| 1 | Consider updated definitions of ASM and related guidance, before developing new ASM | -
| 2| Contribute to the IALA AIS ASM collection | -
| 3| Low transmission frequency | -
| 4| Use 6-bit ASCII | -
| 5| Fixed length messages | -
| 6| Fixed bit-offset for fields | -
| 7| Variable fields last | -
| 8| One dispatch field | -
| 9| Minimum no. of datatypes | -
| 10| Single point of truth | -
| 11| Support stream-based parsers | -
| 12| Don't split data fields across datagrams | -
| 13| Check design using ASN.1 | -
| 14| Provide a reference implementation | -
| 15| Provide test data sets for all message variants | -

|===

== Test data
The test data pairs listed in this section are calculated (and can be validated) as described in the appendix: <<compute_test_data_pairs>>.

=== Tactical voyageplan broadcast

==== Variant 1: Cancel route
[cols="1,3"]
|===
|Parameter |Test value

|Message ID |8
|Repeat Indicator |0
|Src ID |219000001
|Spare |0
.2+|IAI |DAC = 219
|FI = 1
.4+|ETA active WP |UTC month = 0
|UTC day = 0
|UTC hour = 0
|UTC minute = 0
|Duration |0
|No. of waypoints| 0
|===

----
!AIVDM,1,1,0,,83@ndh@nh@0000000,3*4B
----

==== Variant 2: With 4 waypoints

[cols="1,3"]
|===
|Parameter |Test value

|Message ID |8
|Repeat Indicator |0
|Src ID |219000001
|Spare |0
.2+|IAI |DAC = 219
|FI = 1
.4+|ETA active WP |UTC month = 1
|UTC day = 16
|UTC hour = 12
|UTC minute = 29
|Duration |30
|No. of waypoints| 4
.2+|WP~0~ |lon = 10.025599
|lat = 55.846578
.2+|WP~1~ |lon = 10.049975
|lat = 55.828263
.2+|WP~2~ |lon = 10.071840
|lat = 55.811868
.2+|WP~3~ |lon = 10.125227
|lat = 55.796335
|===

----
!AIVDM,1,1,0,,83@ndh@nhAPil01pP;NBwWwBVd5h2`CwSst2pJt1wgTA1Ldh0wnaDP,5*12
----

=== Tactical voyageplan broadcast, extended

==== Variant 1: Cancel tactical voyageplan

[cols="1,3"]
|===
|Parameter |Test value

|Message ID |8
|Repeat Indicator |0
|Src ID |219000001
|Spare |0
.2+|IAI |DAC = 219
|FI = 4
|===

----
!AIVDM,1,1,0,,83@ndh@ni0,4*0D
----

==== Variant 2: With active waypoints, no following waypoints

[cols="1,3"]
|===
|Parameter |Test value

|Message ID |8
|Repeat Indicator |0
|Src ID |219000001
|Spare |0
.2+|IAI |DAC = 219
|FI = 4
.2+|WP~_0_~, position |lon = 9.866598
|lat = 55.856310
.2+|WP~_0_~, ETA |UTC hour = 23
|UTC minute = 59
|WP~_0_~, TCR |255
|===

----
!AIVDM,1,1,0,,83@ndh@ni0FUCG?vhWEvwt,2*5A
----

==== Variant 3: With 12 following waypoints

[cols="1,3"]
|===
|Parameter |Test value

|Message ID |8
|Repeat Indicator |0
|Src ID |219000001
|Spare |0
.2+|IAI |DAC = 219
|FI = 4
|WP~_0_~ |lon = 9.866598, lat = 55.856310, +
hour = 23, minute = 59, +
tcr = 255
|WP~_1_~ |lon = 9.887884, lat = 55.854913, eta = 24, tcr = 127
|WP~_2_~ |lon = 9.980881, lat = 55.844410, eta = 1, tcr = 127
|WP~_3_~ |lon = 10.012982, lat = 55.846337, eta = 7, tcr = 127
|WP~_4_~ |lon = 10.028260, lat = 55.846337, eta = 11, tcr = 127
|WP~_5_~ |lon = 10.035126, lat = 55.833710, eta = 15, tcr = 127
|WP~_6_~ |lon = 10.054009, lat = 55.826865, eta = 16, tcr = 127
|WP~_7_~ |lon = 10.060876, lat = 55.816836, eta = 6, tcr = 127
|WP~_8_~ |lon = 10.076668, lat = 55.809216, eta = 4, tcr = 127
|WP~_9_~ |lon = 10.125077, lat = 55.796384, eta = 17, tcr = 127
|WP~_10_~ |lon = 10.262749, lat = 55.781906, eta = 255, tcr = 127
|WP~_11_~ |lon = 10.269788, lat = 55.776307, eta = 16, tcr = 127
|WP~_12_~ |lon = 10.272706, lat = 55.762402, eta = 1, tcr = 127
|===

----
!AIVDM,3,1,0,,83@ndh@ni0FUCG?vhWEvwt5b6fSwcg`<?p;K1HWwAEH1OhFrge?vTs@>wPequ,0*7D
!AIVDM,3,2,0,,pOu9nPew1Kou@wqHQ1sv2p62awiho47t5hL;SwPUd3?p;R2HWvte`4OhG;:V?,0*27
!AIVDM,3,3,0,,ubHhRwPfvbROrjn?uw1N1M4wm;L23v2t6E1w`DQ0Gt,2*1B
----

=== Tactical voyageplan, inquiry

==== Variant 1: Inquiry with duration
[cols="1,3"]
|===
|Parameter |Test value

|Message ID |6
|Repeat Indicator |2
|Src ID |219000001
|Seq. no. |2
|Dest. ID |219019416
|Retransmit Flag |0
|Spare |0
.2+|IAI |DAC = 219
|FI = 5
|Duration |240
|===

----
!AIVDM,1,1,0,,63@ndh@l=v9P=dGh,0*08
----

=== Flow management suggestion

==== Variant 1: With active waypoints, no following waypoints

[cols="1,3"]
|===
|Parameter |Test value

|Message ID |6
|Repeat Indicator |0
|Src ID |219000001
|Seq no |0
|Dest ID |219019416
|Retransmit Flag |0
|Spare |0
.2+|IAI |DAC = 219
|FI = 6
.2+|WP~_0_~, position |lon = 9.866598
|lat = 55.856310
.2+|WP~_0_~, ETA |UTC hour = 23
|UTC minute = 59
|===

----
!AIVDM,1,1,0,,63@ndh@l=v9P=dH5aDmkwd9mOd,2*17
----

==== Variant 2: With 12 following waypoints

[cols="1,3"]
|===
|Parameter |Test value

|Message ID |6
|Repeat Indicator |0
|Src ID |219000001
|Seq no |0
|Dest ID |219019416
|Retransmit Flag |0
|Spare |0
.2+|IAI |DAC = 219
|FI = 6
.2+|WP~_0_~, position |lon = 9.866598
|lat = 55.856310
.2+|WP~_0_~, ETA |UTC hour = 23
|UTC minute = 59
|WP~_1_~ |lon = 9.887884, lat = 55.854913, eta = 24
|WP~_2_~ |lon = 9.980881, lat = 55.844410, eta = 1
|WP~_3_~ |lon = 10.012982, lat = 55.846337, eta = 7
|WP~_4_~ |lon = 10.028260, lat = 55.846337, eta = 11
|WP~_5_~ |lon = 10.035126, lat = 55.833710, eta = 15
|WP~_6_~ |lon = 10.054009, lat = 55.826865, eta = 16
|WP~_7_~ |lon = 10.060876, lat = 55.816836, eta = 6
|WP~_8_~ |lon = 10.076668, lat = 55.809216, eta = 4
|WP~_9_~ |lon = 10.125077, lat = 55.796384, eta = 17
|WP~_10_~ |lon = 10.262749, lat = 55.781906, eta = 255
|WP~_11_~ |lon = 10.269788, lat = 55.776307, eta = 16
|WP~_12_~ |lon = 10.272706, lat = 55.762402, eta = 1
|===

----
!AIVDM,3,1,0,,63@ndh@l=v9P=dH5aDmkwd9mOd5b6fSwcg`<0ed5ROu5EP45fcsCwa>l3Pequ,0*52
!AIVDM,3,2,0,,pOu9nPd5gOm3wUR47Pf1PbOtL=i05hL;SwPUd30f89ROsjnP@5jjaSwJV<8Pf,0*46
!AIVDM,3,3,0,,vbROrjn?t5p5lCwDeh80g1U@Or58@4,2*0F
----

== Reference implementation

=== AIS
A reference implementation of encoding and decoding of the flow management related AIS messages programmed in Java is publically available in:

- https://github.com/tbsalling/AisLib/tree/flow-management.

==== Tactical voyageplan broadcast

The reference implementation of the _tactical voyageplan broadcast_ message is located in

- https://github.com/tbsalling/AisLib/blob/flow-management/ais-lib-messages/src/main/java/dk/dma/ais/message/binary/BroadcastIntendedRoute.java

with an accompanying unit test class in

- https://github.com/tbsalling/AisLib/blob/flow-management/ais-lib-messages/src/test/java/dk/dma/ais/message/binary/BroadcastIntendedRouteTest.java

==== Tactical voyageplan broadcast, extended

The reference implementation of the _tactical voyageplan extended broadcast_ message is located in

- https://github.com/tbsalling/AisLib/blob/flow-management/ais-lib-messages/src/main/java/dk/dma/ais/message/binary/TacticalVoyagePlan.java

with an accompanying unit test class in

- https://github.com/tbsalling/AisLib/blob/flow-management/ais-lib-messages/src/test/java/dk/dma/ais/message/binary/TacticalVoyagePlanTest.java

==== Tactical voyageplan, inquiry
The reference implementation of the _tactical voyageplan, inquiry_ message is located in

- https://github.com/tbsalling/AisLib/blob/flow-management/ais-lib-messages/src/main/java/dk/dma/ais/message/binary/TacticalVoyagePlanInquiry.java

with an accompanying unit test class in

- https://github.com/tbsalling/AisLib/blob/flow-management/ais-lib-messages/src/test/java/dk/dma/ais/message/binary/TacticalVoyagePlanInquiryTest.java

==== Flow management suggestion

The reference implementation of the _flow management suggestion_ message is located in

- https://github.com/tbsalling/AisLib/blob/flow-management/ais-lib-messages/src/main/java/dk/dma/ais/message/binary/FlowManagementSuggestion.java

with an accompanying unit test class in

- https://github.com/tbsalling/AisLib/blob/flow-management/ais-lib-messages/src/test/java/dk/dma/ais/message/binary/FlowManagementSuggestionTest.java

:numbered!:

[appendix]
[[ais_message_definitions]]
== AIS message definitions

The following AIS message definitions are proposed for flow management support.

[[tactical_voyageplan_broadcast]]
=== Tactical voyageplan broadcast (defined)
Formally proposed specification copied from <<ASM_219_01>>:

====

This message allows the communication of a vessels intended route to other vessels and shore stations.

The rules for broadcasting this message are the following

a. Only broadcast when the vessel is following an activated route.
a. The route must be broadcast every six minutes, due to what is stated in ITU-R M.1371-4 (§4.2.1) regarding sending interval for voyage related information.
a. On route activation the route must be broadcast.
a. When active waypoint changes the route must be broadcast.
a. On route deactivation, or when a route is completed, an empty message with no waypoints must be sent to indicate that the vessel is not following an intended route.

The broadcast waypoints must start with the current active waypoint and include up to the 15 following waypoints, giving a maximum of 16 waypoints.

Broadcasting 16 waypoints will result in a 5-slot message. It is recommended to avoid messages with more than 3 slots, equivalent to no more than 8 waypoints.

See http://enav.frv.dk/ais_route_suggestion.pdf for usage and portrayal details.

*Registrant*: Danish Maritime Authority +
*Message number*: 8 +
*DAC*:  219 +
*FI*:  1 +
*Used by*: DMA, EfficienSea +
*Number of Slots (max)*:  3 +
*Reporting rate*:  Every 6 minutes and on active route change +
*How portrayed*: See http://enav.frv.dk/ais_route_suggestion.pdf for usage and portrayal details.

*Permitted as from*:  11/03/2011 +
*Status*:  initiation +
*Technical Point of contact*: +
Ole Borup +
Danish Maritime Authority +
obo@frv.dk +

*Details*: +
Table 2.1 +
Intended route (broadcast)

[cols="4,>2,12"]
|===
|Parameter |No. of bits |Description

|Message ID |6 |Identifier for Message 8; always 8.
|Repeat Indicator |2 |Used by the repeater to indicate how many times a message has been repeated. +
0 - 3 +
0 = default +
3 = do not repeat anymore
|Source ID |30 |MMSI number of source station.
|Spare |2 |Not used. Set to zero. +
 +
Note: <<ASM_219_01>> states 1 spare bit; but this is not compliant with the format of message type 8 in <<AISSPEC5>>, which states 2 spare bits. 2 spare bits is assumed to be correct.
|IAI |16 |*DAC = 219; FI = 1*
|ETA active WP | |The ETA at the active waypoint (first waypoint). For a cancellation of active route, the default values can be used.
|UTC Month |4 |1 - 12 +
0 = not available = default
|UTC Day |5 |1 - 31 +
0 = not available = default
|UTC Hour |5 |0 - 23 +
0 = not available = default
|UTC Minute |6 |0 - 59 +
0 = not available = default
|Duration |18 |Minutes from ETA at active waypoint to ETA at the last broadcast waypoint. The duration allows for the calculation of an average intended speed on the broadcast route. +
+
0 = not available = default
|Number of Waypoints |5 |Number of Waypoints +
+
1 - 16 +
0 = no active route = cancel route +
17 - 31 (not used)
|Waypoints |n × 55 |Variable number of waypoints 0 – 16 (55 bit each), refer to table 2.2.
|Spare | |Not used. Set to zero.
|*Total* |*99-979* |*Occupies 2 – 5 slots.* +
1 - 4 waypoints = 2 slots +
5 - 8 waypoints = 3 slots +
9 - 12 waypoints = 4 slots +
13 – 16 waypoints = 5 slots
|===

Table 2.2 +
Waypoints
[cols="4,>2,12"]
|===
|Parameter |No. of bits |Description

|WP Longitude |28 |Longitude in 1/10,000 min, ±180 degrees as per 2's complement (East = positive, West = negative).
|WP Latitude  |27 |Latitude in 1/10,000 min, ±90 degrees as per 2's complement (North = positive, South = negative).
|===

====

[[tactical_voyageplan_broadcast_extended]]
=== Tactical voyageplan broadcast, extended (proposal)

====
*Transmitter* +
Vessels only.

*Transmission prerequisites* +
The message is only transmitted if vessel is conned along an active voyageplan.

*Transmission triggering events* +
The following events must trigger a transmission of this message:

1. Periodically.footnote:[Using AIS: To use periodic transmission intervals as defined for _dynamic information_ in Table 1 of <<AISSPEC5>> (§4.2.1)]
1. On voyage plan activation.
1. On voyage plan change +
(change to waypoints or change of ETA to any waypoint of more than 10 minutes).
1. On voyage plan deactivation/cancellation.
1. On change of active waypoint.
1. As reply to message "tactical voyageplan inquiry".

*Retransmission* +
Retransmission is not applicable.

*Message format*
Waypoints are denoted WP~_0_~, WP~_1_~, WP~_i_~,..., WP~_n_~ and are navigated in sequence. WP~_0_~ is the _active waypoint_ currently steered towards. WP~_i_~, where _i_ ≥ 1, is called _following waypoints_.

[cols="4,>2,12"]
|===
|Parameter |No. of bits |Description

|Message ID |6 |Identifier for Message 8; always 8.
|Repeat Indicator |2 |Used by the repeater to indicate how many times a message has been repeated. +
0 - 3 +
0 = default +
3 = do not repeat anymore
|Source ID |30 |MMSI number of source station.
|Spare |2 |Not used. Set to zero.
|IAI |16 |*DAC = 219; FI = 4*
3+^.^|_Message may end here to indicate cancellation of previously announced tactical voyageplan._
.2+|WP~_0_~, position |28 | Longitude in 1/10,000 min, ±180 degrees as per 2's complement (East = positive, West = negative).
>|27 <| Latitude in 1/10,000 min, ±90 degrees as per 2's complement (North = positive, South = negative).
.2+|WP~_0_~, ETA |5 |UTC hour +
Integer value +
Values outside the range 0-23 are illegal and must not be used. +
Values are current or future.
>|6 <|UTC minute +
Integer value +
Values outside the range 0-59 are illegal and must not be used.
|WP~_0_~, TCR |8 |Turn circle radius at the active waypoint. +
Type: Integer. Unit: 1/100 of a nautical mile. +
0 = no value +
1 - 255 = turn circle radius of 0.01 nm - 2.55 nm
|Following waypoints with ETA and TCR | n × 63 | Variable no. of planned waypoints and ETA's. +
n ∈ {0..12} +
 See table 2
|*Total* | *56* +
*130* +
*201* +
*...* +
*982*
|56 bits for cancellation. +
130 bits for WP~_0_~, no following WP's. +
201 bits for WP~_0_~, 1 following WP. +
... +
982 bits for WP~_0_~, 12 following WP. +
|===

[cols="4,>2,12"]
.Following waypoints.
|===
|Parameter |No. of bits |Description

|WP~_i_~, longitude |28 |Longitude in 1/10,000 min, ±180 degrees as per 2's complement (East = positive, West = negative).
|WP~_i_~, latitude  |27 |Latitude in 1/10,000 min, ±90 degrees as per 2's complement (North = positive, South = negative).
|WP~_i_~, relative ETA | 8 | Relative ETA from previous waypoint; measured in minutes. +
Integer value; [0-255]. +
0 = Not used. Illegal value. +
1 - 255 = Relative ETA measured in number of minutes from previous waypoint.
|WP~_i_~, TCR |8 |Turn circle radius at WP~_i_~. +
Type: Integer. Unit: 1/100 of a nautical mile. +
0 = no value +
1 - 255 = turn circle radius of 0.01 nm - 2.55nm
|*Total* |*71* |
|===

[cols="8,>2,>2"]
.No. of transmission slots.
|===
|Payload | Bits | Slots

|Cancellation | 55 | 1
|Active waypoint, no following waypoints | 130 | 1
|Active waypoint, 1 following waypoint | 201 | 2
|Active waypoint, 2 following waypoints | 272 | 2
|Active waypoint, 3 following waypoints | 343 | 2
|Active waypoint, 4 following waypoints | 414 | 3
|Active waypoint, 5 following waypoints | 485 | 3
|Active waypoint, 6 following waypoints | 556 | 3
3+^.^|_Transmitting more than 3 slots is not recommended_
| _Active waypoint, 7 following waypoints_ | 627 | 4
| _Active waypoint, 8 following waypoints_ | _698_ | _4_
| _Active waypoint, 9 following waypoints_ | _769_ | _4_
| _Active waypoint, 10 following waypoints_ | _840_ | _5_
| _Active waypoint, 11 following waypoints_ | _911_ | _5_
| _Active waypoint, 12 following waypoints_ | _982_ | _5_
|===

====

[[tactical_voyageplan_inquiry]]
=== Tactical voyageplan inquiry (proposal)

====

*Transmitter* +
Vessels and coordination centres.

*Transmission triggering events* +
The following events should trigger transmission:

1. On need by control centre to receive tactical voyageplan from a vessel. In case of e.g.:
- A vessel's arrival to controlled area.
- A vessel's previously announced tactical voyageplan is considered invalid by the inquirer, e.g. because
* the timestamp of the active waypoint is in the past.
* the vessel's manouvers deviate significantly from its announced tactical voyageplan.
- Loss of data in control center.
1. On need by vessel to receive tactical voyageplan from another vessel.
- The inquired vessel's intentions are unknown to the inquirying vessel; e.g. in case of
* Tactical voyageplan was never transmitted by inquired vessel.
* Tactical voyageplan was never received by inquirying vessel.
* Information about another vessel's tactical voyageplan was lost onboard the inquirying vessel (e.g. due to system restart or improper operation).

*Retransmission* +
Except in the sense of missing protocol acknowledgement as per <<AISSPEC5>>, Annex 8 §3.5 -- retransmission is not applicable.

*Message format*
[cols="4,>2,12"]
|===
|Parameter |No. of bits |Description

|Message ID |6 |Identifier for Message 6; always 6.footnote:[Message type 25 could also be considered. But this message type is very rate and not known to be used in any other applications.]
|Repeat Indicator |2 |Used by the repeater to indicate how many times a message has been repeated. +
0 - 3 +
0 = default +
3 = do not repeat anymore
|Source ID |30 |MMSI number of source station.
|Sequence number |2 |0-3; refer to <<AISSPEC5>> §5.3.1, Annex 2
|Destination ID |30 |MMSI number of destination station.
|Retransmit Flag |1 |Retransmit Flag should be set upon retransmission: +
0 = no retransmission = default
1 = retransmitted.
|Spare |1 |Not used. Set to zero.
|IAI |16 |*DAC = 219; FI = 5*
|Duration |8 |0 = One-shot inquiry with no request to transmit periodically _or_ (if the addressed vessel is still periodically transmitting as a result of a previous inquiry from the same source) a request to cease periodic transmissions of tactical voyageplan. +
 +
1-255 = Duration (in minutes) for which the addressed vessel is requested to transmit its tactical voyageplan periodically, as per triggering criteria of <<tactical_voyageplan_broadcast>> and  <<tactical_voyageplan_broadcast_extended>>. If a retransmission period (requested from the same source) has not yet expired, the duration is reset to the new value. +
 +
Type: Integer.
|*Total* |*96* |
|===

[cols="8,>2,>2"]
.No. of transmission slots.
|===
|Payload | Bits | Slots

|Inquiry | 96 | 1
====

[[flow_management_suggestion]]
=== Flow management suggestion (proposal)

====

*Transmitter* +
Coordination centers (for controlled flow management).

*Transmission prerequisites* +
The message is only transmitted if the receiving vessel has previously broadcast a tactical voyage plan which is still considered valid by the control center (e.g. ETA of active waypoint is in the future).

This message can only be sent in response to a "Tactical voyageplan broadcast" or a "Tactical voyageplan broadcast, extended".

The latitude and longitude of suggested active and planned waypoints must match exactly those received in the latest "Tactical voyageplan broadcast" or a "Tactical voyageplan broadcast, extended". If this is not the case, the vessel, to which the flow management suggestion is addressed, must disregard it, and broadcast a new tactical voyageplan message.

*Transmission triggering events* +
The following events must trigger a transmission of this message:

1. On coordination center determining that speed-based changes to tactical voyageplan of vessel will lead to a better overall flow.

*Retransmission* +
Retransmission is not applicable.

*Message format* +
Waypoints are denoted WP~_0_~, WP~_1_~, WP~_i_~,..., WP~_n_~ and are navigated in sequence. WP~_0_~ is the _suggested active waypoint_ currently to be steered towards. WP~_i_~, where _i_ ≥ 1, is called the _following suggested waypoints_.

[cols="4,>2,12"]
|===
|Parameter |No. of bits |Description

|Message ID |6 |Identifier for Message 6; always 6.
|Repeat Indicator |2 |Used by the repeater to indicate how many times a message has been repeated. +
0 - 3 +
0 = default +
3 = do not repeat anymore
|Source ID |30 |MMSI number of source station.
|Sequence number |2 |0-3; refer to <<AISSPEC5>> §5.3.1, Annex 2
|Destination ID |30 |MMSI number of destination station.
|Retransmit Flag |1 |Retransmit Flag should be set upon retransmission: +
0 = no retransmission = default
1 = retransmitted.
|Spare |1 |Not used. Set to zero.
|IAI |16 |*DAC = 219; FI = 6*
.2+|WP~_0_~, position |28 | Longitude in 1/10,000 min, +
±180 degrees as per 2's complement (East = positive, West = negative).
>|27 <| Latitude in 1/10,000 min, +
±90 degrees as per 2's complement (North = positive, South = negative).
.2+|WP~_0_~, ETA |5 |UTC hour +
Integer value +
Values outside the range 0-23 are illegal and must not be used. +
Values are current or future.
>|6 <|UTC minute +
Integer value +
Values outside the range 0-59 are illegal and must not be used.
|Suggested following waypoints with relative ETA | n × 63 | Variable no. of planned waypoints and ETA's. +
n ∈ {0..12} +
See table "<<table_suggested_following_waypoints>>" below.
|*Total* | *154-1006* |
|===

[[table_suggested_following_waypoints]]
[cols="4,>2,12"]
.Suggested following waypoints.
|===
|Parameter |No. of bits |Description

|WP~_i_~, longitude |28 |Longitude in 1/10,000 min, ±180 degrees as per 2's complement (East = positive, West = negative).
|WP~_i_~, latitude  |27 |Latitude in 1/10,000 min, ±90 degrees as per 2's complement (North = positive, South = negative).
|WP~_i_~, relative ETA | 8 | Relative ETA from previous waypoint; measured in minutes. +
Integer value; [0-255]. +
0 = Not used. Illegal value. +
1 - 255 = Relative ETA measured in number of minutes from previous waypoint.
|*Total* |*63* |
|===

[cols="8,>2,>2"]
.No. of transmission slots.
|===
|Payload | Bits | Slots

|Suggested active waypoint, no following suggested waypoints | 154 | 2
|Suggested active waypoint, 1 following suggested waypoint | 217 | 2
|Suggested active waypoint, 2 following suggested waypoints | 280 | 2
|Suggested active waypoint, 3 following suggested waypoints | 343 | 2
|Suggested active waypoint, 4 following suggested waypoints | 406 | 3
|Suggested active waypoint, 5 following suggested waypoints | 469 | 3
| Suggested active waypoint, 6 following suggested waypoints | 532 | 3
3+^.^|_Transmitting more than 3 slots is not recommended_
| _Suggested active waypoint, 7 following suggested waypoints_ | 595 | 4
| _Suggested active waypoint, 8 following suggested waypoints_ | _658_ | _4_
| _Suggested active waypoint, 9 following suggested waypoints_ | _721_ | _4_
| _Suggested active waypoint, 10 following suggested waypoints_ | _784_ | _4_
| _Suggested active waypoint, 11 following suggested waypoints_ | _847_ | _5_
| _Suggested active waypoint, 12 following suggested waypoints_ | _910_ | _5_
|===

====

[appendix]

[[compute_test_data_pairs]]
== Calculating test data pairs
A test data pair can be computed like this: First, a message variant is chosen - and test data values are chosen for each data field. This is an example for the _tactical voyageplan, inquiry_ message:

[cols="4,>2,>4,12"]
|===
|Parameter |Bits |Test value (decimal) | Test value (binary)

|Message ID |6 |6 |000110
|Repeat Indicator |2 |0 |00
|Src ID |30 |219000001 |001101000011011010110011000001
|Seq. no. |2 |0 |00
|Dest. ID |30 |219019416 |001101000011011111100010011000
|Retransmit Flag |1 |0 |0
|Spare | 1|0 |0
.2+|IAI |10 |DAC=291 |0011011011
>|6 |FI=5 <|000101
|Duration | 8|240|11110000
|*Total* | |*88* |
|===

Then, concatenating all the binary values and grouping them into 6-bit nibbles yields:

----
000110 000011 010000 110110 101100 110000
010000 110100 001101 111110 001001 100000
001101 101100 010111 110000
----

Incidentally, the last nibble fills up to six bits. If it didn't zero's would have to be padded at the end until the total number of bits were a multiple of six.

Using table 2 in the "AIVDM/AIVDO Payload Armoring"-section of <<RAYMOND>>, these 15 6-bit nibbles can be converted into ASCII like this:

----
000110 -> "6"
000011 -> "3"
010000 -> "@"
110110 -> "n"
101100 -> "d"
110000 -> "h"
010000 -> "@"
110100 -> "l"
001101 -> "="
111110 -> "v"
001001 -> "9"
100000 -> "P"
001101 -> "="
101100 -> "d"
010111 -> "G"
110000 -> "h"
----

In conclusion the ASCII-armoured representation of this message is: `63@ndh@l=v9P=dGh`.

In communication with a base station or a transponder, this ASCII-armoured value needs to be in the payload of an NMEA0183 message like VDM or VDO, like this:

`!AIVDM,1,1,0,,63@ndh@l=v9P=dGh,0*08`

A good explanation of NMEA encapsulation of AIS data is found in the "AIVDM/AIVDO Sentence Layer" section of <<RAYMOND>>.

The \*-separated suffix ("*08") is the NMEA 0183 data-integrity CRC32 checksum for the sentence, preceded by "*". It is computed on the entire sentence including the AIVDM tag but excluding the leading "!" and the trailing "*". The checksum is computed as the last to digits of the XOR of all of the bytes in the sentence in hexadecimal notation. As explained by <<WIKINMEA>> the C implementation can look like this:

[source, c]
----
#include <stdio.h>
#include <string.h>

int checksum(char *s) {
  int c = 0;

  while(*s)
    c ^= *s++;

  return c;
}

int main()
{
  char mystring[] = "AIVDM,1,1,0,,63@ndh@l=v9P=dGh,0";
  printf("Checksum: 0x%02X\n", checksum(mystring));
  return 0;
}
----

Running the algorithm as a C program yields:

----
$ gcc checksum.c
$ ./a.out
Checksum: 0x08
----

Thus -- this particular case -- the checksum is 0x08 and thus the complete NMEA amour containing our AIS data is:

----
!AIVDM,1,1,0,,63@ndh@l=v9P=dGh,0*08
----

[glossary]
== Glossary

[[definitions]]
=== Definitions

[cols="1,6"]
|===
|Term |Definition

|Strategic voyageplan | MONALISA 2 term for long term planning that consists of a route with a voyage number (and other Route information), a list of waypoints (geometry), a schedule, charter parties, legal conditions, and more. When a Strategic voyage plan is given to the ship as a voyage order it changes to _dynamic voyageplan_.
|Dynamic voyageplan | MONALISA 2 term for an optimised version of the _strategic voyageplan_
|Tactical voyageplan | MONALISA 3 term for a dynamic voyageplan in conning mode; i.e. under tactical execution. Whole or parts of the tactical voyage plan can be transmitted to increase situational awareness and support flow management.
|Turn circle radius | Merchant ships usually turn in a circle having a radius of about 6–8 times the length between perpendiculars. Turn radius varies little with speed, but can vary significantly between manouvers in deep and shallow waters. The radius depends on the size and geometry of a vessel, the size of its rudder, and the no. and characteristics of propellers. Cf. <<SBTCD>> for more.
|===

=== Abbreviations

[cols="1,3,3"]
|===
|Abbreviation |Expansion | Description

|MSDL |Maritime Service Definition Language | A computer language used to defined services in a maritime
|AIS |Automatic Identification System |A tracking system used on ships and by vessel traffic services for identifying and locating vessels by electronically exchanging data with other nearby ships, base stations, and satellites.
|ASM |Application Specific Message |Used only in the context of the automatic identification system, as a method of allowing "competent authorities" to define additional AIS message subtypes, based on message types 6, 8, 25, and 26 which support a custom payload.
|CC | Coordination Center |A term specific to this document invented to cover all types of VTS, STCC, and other centres with responsibility for traffic management and coordination.
|STM |Sea Traffic Management |The aggregation of the seaborne and shore-based functions (sea traffic services, maritime space management and sea traffic flow management) required to ensure the safe and efficient manouvering of vessels during all phases of operation.
|STCC |Sea Traffic Coordination Center |A central, shore-based, hub maintaining record of all vessels at sea using AIS and/or radar to enable managed distribution of vessel routes between ship-to-ship and ship-to-shore.
|VTS |Vessel traffic service |A vessel traffic service is a marine traffic monitoring system established by public or port authorities, somewhat similar to air traffic control for aircraft.
|IALA |International Association of Lighthouse Authorities |The International Association of Marine Aids to Navigation and Lighthouse Authorities is a non-profit organization founded collect and provide nautical expertise and advice.
|ITU |International Telecommunication Union |The International Telecommunication Unio is an agency of the United Nations that is responsible for issues that concern information and communication technologies, such as coordinating the shared global use of the radio spectrum, promoting international cooperation in assigning satellite orbits, assisting in the development of worldwide technical standards.
|ASCII |American Standard Code for Interformation Interchange | A character encoding scheme used in computers, communications equipment, and other devices that use text, to represent text with numbers.
|ETA |Estimated time of arrival |-
|SOG |Speed over ground |Speed made good (often measured in knots).
|TCR |Turn circle radius| Turning circle radius (often measured in nautical miles).
|===

[bibliography]
== Bibliography

=== Standards and specifications

[[[AISSPEC5]]] "Recommendation ITU-R M.1371-5: Technical characteristics for an automatic identification system using time division multiple access in the VHF maritime mobile frequency band". February, 2014. International Telecommunications Union. Available from http://www.itu.int/rec/R-REC-M.1371-5-201402-I.

[[[IMOSN289]]] "Guidance on the use of AIS application-specific messages". Published as SN.1/Circ.289 by the International Maritime Organization (IMO). June 2, 2010.

[[[IALA144]]] "IALA Recommendation e-NAV - 144 On Harmonized implementation of Application Specific Messages (ASM)". Edition 1. June, 2011. International Association of Marine Aids to Navigation and Lighthouse Authorities.

[[[AISASM]]] "Application Specific Messages". IALA maintained collection of regional applications for AIS Application Specific Messages in use. http://www.e-navigation.nl/asm.

=== Articles and papers

[[[TOILS]]] "The Toils of AIS: A Case Study in Application Protocol Design And Analysis" by Eric S. Raymond and Kurt Schwehr. 2013. Available from http://gitorious.org/toils-of-ais/toils-of-ais/

[[[ARCH]]] "Architecture for STM in EMSN and STM Data format for Route Exchange".

[[[RAYMOND]]] "AIVDM/AIVDO protocol decoding" by Eric S. Raymond
<esr@thyrsus.com>. Version 1.46, Aug 2014. http://catb.org/gpsd/AIVDM.html.

[[[WIKINMEA]]] "NMEA 0183", Aug 28, 2014. http://en.wikipedia.org/wiki/NMEA_0183.

=== Web resources

[[[ASN.1]]] "Abstract Syntax Notation One (ASN.1)". A standard and notation that describes rules and structures for representing, encoding, transmitting, and decoding data in telecommunications and computer networking. http://en.wikipedia.org/wiki/Abstract_Syntax_Notation_One.

[[[BDEC]]] "bdec". A set of tools for creating decoders and encoders for binary files given a high level specification. http://www.protocollogic.com/docs/tutorial.html.

[[[MONALISA2]]] "MONALISA 2.0". A joint project from 10 different countries in the European Union to introduce Sea Traffic Management (STM) and make real-time information available to all interested and authorised parties in the maritime world. http://monalisaproject.eu/.

[[[ASMCOLL]]] "Application Specific Messages". A collection of application specific AIS messages approved by IALA-AISM. http://www.e-navigation.nl/asm.

[[[ASM_001_27]]] "Specification of Route information - (broadcast)". Specification of the AIS application specific message for route information broadcast. http://www.e-navigation.nl/content/route-information.

[[[ASM_219_01]]] "Specification of intended route - (broadcast)". Specification of the AIS application specific message for intended route broadcast. http://www.e-navigation.nl/content/intended-route.

[[[ASM_219_02]]] "Specification of route suggestion". Specification of the AIS application specific message for intended route broadcast. http://www.e-navigation.nl/content/route-suggestion.

[[[SBTCD]]] Blog entry on "Turning Circle Diameter for a Container Ship". http://shipsbusiness.com/turning-circle.html.
